<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Timetable Generator - Automated Academic Scheduling</title>
    <meta name="description" content="Generate optimized class schedules for educational institutions with intelligent scheduling algorithms">
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
</head>
<body>
    <!-- Header -->
    <header class="university-header">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="graduation-cap" class="h-8 w-8"></i>
                    <div>
                        <h1 class="text-2xl font-bold">College Timetable Generator</h1>
                        <p class="primary-foreground-80 text-sm">Automated Academic Scheduling System</p>
                    </div>
                </div>
                <nav class="flex space-x-4">
                    <button id="adminBtn" class="nav-btn active">
                        <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                        Admin Panel
                    </button>
                    <button id="timetableBtn" class="nav-btn" disabled>
                        <i data-lucide="calendar" class="h-4 w-4 mr-2"></i>
                        View Timetable
                    </button>
                    <button id="facultyBtn" class="nav-btn">
                        <i data-lucide="users" class="h-4 w-4 mr-2"></i>
                        Faculty View
                    </button>
                    <button id="addFacultyBtn" class="nav-btn">
                        <i data-lucide="user-plus" class="h-4 w-4 mr-2"></i>
                        Add Faculty
                    </button>
                    <button id="logoutBtn" class="btn btn-outline btn-sm">
                        <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
                        Logout
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Admin Panel View -->
    <div id="adminView" class="view active space-y-8">
            <!-- Hero Section -->
            <div class="text-center space-y-6 py-12">
                <h1 class="text-4xl font-bold text-university-primary">Smart Timetable Generator</h1>
                <p class="text-lg text-muted-foreground max-w-2xl mx-auto">
                    Automatically generate optimized class schedules for your educational institution with our intelligent scheduling system.
                </p>
            </div>
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-foreground mb-2">Timetable Configuration</h2>
                <p class="text-muted-foreground">Set up branches, sections, subjects, and faculty assignments</p>
            </div>

            <!-- Branch and Section Selection -->
            <div class="admin-card">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="book-open" class="h-5 w-5 mr-2 text-primary"></i>
                    Branch & Section Selection
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="branchSelect" class="block text-sm font-medium">Select Branch</label>
                        <select id="branchSelect" class="custom-select">
                            <option value="">Choose a branch</option>
                            <!-- Branch options will be populated dynamically by JS -->
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="sectionSelect" class="block text-sm font-medium">Select Section</label>
                        <select id="sectionSelect" class="custom-select">
                            <option value="">Choose a section</option>
                            <select id="sectionSelect" class="custom-select">
                            <option value="A"></option>
                            <option value="B"></option>
                            <option value="C"></option>
                            <!-- Section options will be populated dynamically by JS -->
                        </select>
                    </div>
                </div>
                <div id="selectionDisplay" class="mt-4 p-3 bg-primary-10 rounded-lg hidden">
                    <p class="text-sm text-primary font-medium"></p>
                </div>
            </div>

            <!-- Subject Management -->
            <div class="admin-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold flex items-center">
                        <i data-lucide="clock" class="h-5 w-5 mr-2 text-primary"></i>
                        Subject Management
                    </h3>
                    <div class="space-x-2">
                        <button id="loadDefaultBtn" class="btn btn-outline btn-sm">
                            Load Default Subjects
                        </button>
                        <button id="addSubjectBtn" class="btn btn-primary btn-sm">
                            Add Subject
                        </button>
                    </div>
                </div>
                <div id="subjectsContainer">
                    <div id="noSubjects" class="text-center py-8 text-muted-foreground">
                        <i data-lucide="book-open" class="h-12 w-12 mx-auto mb-4 opacity-50"></i>
                        <p>No subjects configured. Add subjects or load default subjects to get started.</p>
                    </div>
                    <div id="subjectsList" class="space-y-4 hidden"></div>
                </div>
            </div>

            <!-- Generate Timetable -->
            <div class="admin-card">
                <div class="text-center space-y-4">
                    <h3 class="text-xl font-semibold">Generate Timetable</h3>
                    <p class="text-muted-foreground">
                        Create a timetable based on the selected criteria
                    </p>
                    <button id="generateBtn" class="btn btn-primary btn-lg w-full md:w-auto" disabled>
                        <i data-lucide="calendar" class="h-5 w-5 mr-2"></i>
                        Generate Timetable
                    </button>
                    <p id="generateHelp" class="text-sm text-muted-foreground">
                        Please select branch, section, and add subjects to generate a timetable
                    </p>
                </div>
            </div>
        </div>

        <!-- Timetable View -->
    <div id="timetableView" class="view space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-foreground">Generated Timetable</h2>
                    <p id="timetableSubtitle" class="text-muted-foreground mt-1"></p>
                </div>
                <button id="downloadBtn" class="btn btn-outline">
                    <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                    Download
                </button>
            </div>

            <div class="admin-card">
                <div id="timetableGrid" class="timetable-grid"></div>
                <div id="facultyListContainer" class="mt-6"></div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="admin-card p-4">
                    <div class="flex items-center space-x-2">
                        <div class="h-3 w-3 bg-blue-500 rounded"></div>
                        <span class="text-sm font-medium">Theory Classes</span>
                    </div>
                    <p id="theoryCount" class="text-2xl font-bold mt-2">0</p>
                </div>
                <div class="admin-card p-4">
                    <div class="flex items-center space-x-2">
                        <div class="h-3 w-3 bg-purple-500 rounded"></div>
                        <span class="text-sm font-medium">Lab Sessions</span>
                    </div>
                    <p id="labCount" class="text-2xl font-bold mt-2">0</p>
                </div>
                <div class="admin-card p-4">
                    <div class="flex items-center space-x-2">
                        <div class="h-3 w-3 bg-green-500 rounded"></div>
                        <span class="text-sm font-medium">Total Periods</span>
                    </div>
                    <p id="totalCount" class="text-2xl font-bold mt-2">0</p>
                </div>
            </div>
        </div>

    <!-- Faculty View -->
    <div id="facultyView" class="view space-y-6">
            <h2 class="text-3xl font-bold text-foreground mb-2">Faculty Schedule View</h2>
            <p class="text-muted-foreground">Select a faculty member to view their teaching schedule</p>
            <div class="admin-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold flex items-center">
                        <i data-lucide="user" class="h-5 w-5 mr-2 text-primary"></i>
                        Select Faculty
                    </h3>
                    <button id="downloadFacultyBtn" class="btn btn-outline btn-sm hidden">
                        <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                        Download Schedule
                    </button>
                </div>
                <select id="facultySelect" class="custom-select max-w-md">
                    <option value="">Choose a faculty member</option>
                </select>
            </div>
            <div id="facultyDetails" class="space-y-6 hidden">
                <!-- Faculty Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="admin-card p-4">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="clock" class="h-4 w-4 text-primary"></i>
                            <span class="text-sm font-medium">Total Periods</span>
                        </div>
                        <p id="facultyTotalPeriods" class="text-2xl font-bold mt-2">0</p>
                    </div>
                    <div class="admin-card p-4">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="book-open" class="h-4 w-4 text-blue-500"></i>
                            <span class="text-sm font-medium">Theory Classes</span>
                        </div>
                        <p id="facultyTheoryCount" class="text-2xl font-bold mt-2">0</p>
                    </div>
                    <div class="admin-card p-4">
                        <div class="flex items-center space-x-2">
                            <div class="h-4 w-4 bg-purple-500 rounded"></div>
                            <span class="text-sm font-medium">Lab Sessions</span>
                        </div>
                        <p id="facultyLabCount" class="text-2xl font-bold mt-2">0</p>
                    </div>
                    <div class="admin-card p-4">
                        <div class="flex items-center space-x-2">
                            <div class="h-4 w-4 bg-green-500 rounded"></div>
                            <span class="text-sm font-medium">Subjects</span>
                        </div>
                        <p id="facultySubjectCount" class="text-2xl font-bold mt-2">0</p>
                    </div>
                </div>
                <!-- Faculty Schedule Grid -->
                <div class="admin-card overflow-hidden">
                    <div class="p-6 border-b">
                        <h3 id="facultyScheduleTitle" class="text-xl font-semibold">Weekly Schedule</h3>
                    </div>
                    <div id="facultyScheduleGrid" class="grid grid-cols-6 gap-0"></div>
                </div>
                <!-- Subjects Taught -->
                <div class="admin-card">
                    <h3 class="text-xl font-semibold mb-4">Subjects Taught</h3>
                    <div id="facultySubjectsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
            <div id="noFacultySelected" class="admin-card p-12 text-center">
                <i data-lucide="user" class="h-16 w-16 mx-auto mb-4 text-muted-foreground"></i>
                <h3 class="text-xl font-semibold mb-2">Select Faculty Member</h3>
                <p class="text-muted-foreground">
                    Choose a faculty member from the dropdown above to view their schedule
                </p>
            </div>
        </div>

        <!-- Add Faculty View -->
    <div id="addFacultyView" class="view space-y-6">
            <h2 class="text-3xl font-bold text-foreground mb-2">Add/Delete Faculty</h2>
            <div id="addFacultySection" class="admin-card" style="max-width: 500px; width: 100%; margin: 0 auto;">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="user-plus" class="h-5 w-5 mr-2 text-primary"></i>
                    Add Faculty
                </h3>
                <form id="addFacultyForm" class="flex flex-col md:flex-row gap-4 items-start md:items-end">
                    <div class="flex-1">
                        <label for="facultyNameInput" class="block text-sm font-medium mb-1">Faculty Name</label>
                        <input id="facultyNameInput" type="text" class="custom-input w-full" placeholder="Enter faculty name" required />
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm" style="width:120px;min-width:unset;">Add Faculty</button>
                </form>
                <p id="addFacultyMsg" class="text-sm text-green-600 mt-2 hidden">Faculty added!</p>
                <hr class="my-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="user-minus" class="h-5 w-5 mr-2 text-destructive"></i>
                    Delete Faculty
                </h3>
                <form id="deleteFacultyForm" class="flex flex-col md:flex-row gap-4 items-start md:items-end">
                    <div class="flex-1">
                        <label for="facultyDeleteSelect" class="block text-sm font-medium mb-1">Select Faculty</label>
                        <select id="facultyDeleteSelect" class="custom-select w-full">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-destructive btn-sm" style="width:120px;min-width:unset;">Delete</button>
                </form>
                <p id="deleteFacultyMsg" class="text-sm text-green-600 mt-2 hidden">Faculty deleted!</p>
            </div>
        </div>
        </div>
    </main>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script src="/static/script.js"></script>
    <script>
    // View switching logic - make globally accessible
    function showView(viewId) {
        const views = document.querySelectorAll('.view');
        views.forEach(v => {
            v.classList.remove('active');
            v.style.display = 'none';
        });
        const view = document.getElementById(viewId);
        if (view) {
            view.classList.add('active');
            view.style.display = 'block';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Check authentication
        if (!isAuthenticated() || getCurrentUser()?.role !== 'admin') {
            window.location.href = 'login.html';
            return;
        }

        // Initialize
        lucide.createIcons();
        setupEventListeners();
        loadInitialData();

        // Hide all views except adminView on load
        const views = document.querySelectorAll('.view');
        views.forEach(v => {
            if (v.id === 'adminView') {
                v.classList.add('active');
                v.style.display = 'block';
            } else {
                v.classList.remove('active');
                v.style.display = 'none';
            }
        });

        // Navigation
        document.getElementById('adminBtn').addEventListener('click', function() {
            showView('adminView');
        });
        document.getElementById('timetableBtn').addEventListener('click', function() {
            showView('timetableView');
        });
        document.getElementById('facultyBtn').addEventListener('click', function() {
            showView('facultyView');
            loadFacultyData();
        });
        document.getElementById('addFacultyBtn').addEventListener('click', function() {
            showView('addFacultyView');
            loadFacultyForDeletion();
        });
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Faculty view: fetch and display schedule for selected faculty
        const facultySelect = document.getElementById('facultySelect');
        if (facultySelect) {
            facultySelect.addEventListener('change', async function() {
                const facultyId = facultySelect.value;
                if (!facultyId) {
                    document.getElementById('facultyDetails').classList.add('hidden');
                    document.getElementById('noFacultySelected').classList.remove('hidden');
                    return;
                }
                // Fetch schedule from backend
                const res = await fetch(`/api/faculty/${facultyId}/schedule`);
                const result = await res.json();
                if (result.success) {
                    renderFacultySchedule(result.schedule);
                    document.getElementById('facultyDetails').classList.remove('hidden');
                    document.getElementById('noFacultySelected').classList.add('hidden');
                } else {
                    document.getElementById('facultyDetails').classList.add('hidden');
                    document.getElementById('noFacultySelected').classList.remove('hidden');
                }
            });
        }
    });

    async function loadInitialData() {
        try {
            await Promise.all([
                populateBranchDropdown(),
                populateSectionDropdown(),
                populateFacultyDropdown()
            ]);
        } catch (error) {
            console.error('Failed to load initial data:', error);
        }
    }

    // Fetch and populate branch (department) dropdown from DB
    async function populateBranchDropdown() {
        const select = document.getElementById('branchSelect');
        select.innerHTML = '<option value="">Choose a branch</option>';
        try {
            const response = await fetch('/api/departments');
            const result = await response.json();
            if (result.success && Array.isArray(result.departments)) {
                result.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = `${dept.name} (${dept.code})`;
                    select.appendChild(option);
                });
            }
        } catch (err) {}
    }

    // Fetch and populate faculty dropdown from DB
    async function populateFacultyDropdown() {
        const select = document.getElementById('facultySelect');
        select.innerHTML = '<option value="">Choose a faculty member</option>';
        try {
            const response = await fetch('/api/faculty');
            const result = await response.json();
            if (result.success && Array.isArray(result.faculty)) {
                result.faculty.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = f.name;
                    select.appendChild(option);
                });
            }
        } catch (err) {}
    }

    // Fetch and populate section dropdown from DB (distinct sections from students table)
    async function populateSectionDropdown() {
        const select = document.getElementById('sectionSelect');
        select.innerHTML = '<option value="">Choose a section</option>';
        try {
            const response = await fetch('/api/sections');
            const result = await response.json();
            if (result.success && Array.isArray(result.sections)) {
                result.sections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section;
                    option.textContent = `Section ${section}`;
                    select.appendChild(option);
                });
            }
        } catch (err) {}
    }

    function loadSubjects(subjects) {
        // Deprecated: Use loadDefaultSubjects instead
        // This function is no longer used
    }

    async function loadFacultyData() {
        try {
            const faculty = await fetchFaculty();
            populateFacultyViewDropdown(faculty);
        } catch (error) {
            console.error('Failed to load faculty data:', error);
        }
    }

    function populateFacultyViewDropdown(faculty) {
        const select = document.getElementById('facultySelect');
        select.innerHTML = '<option value="">Choose a faculty member</option>' +
            faculty.map(f => 
                `<option value="${f.id}">${f.first_name} ${f.last_name}</option>`
            ).join('');
    }

    async function loadFacultyForDeletion() {
        try {
            const faculty = await fetchFaculty();
            const select = document.getElementById('facultyDeleteSelect');
            select.innerHTML = '<option value="">Select faculty to delete</option>' +
                faculty.map(f => 
                    `<option value="${f.id}">${f.first_name} ${f.last_name}</option>`
                ).join('');
        } catch (error) {
            console.error('Failed to load faculty for deletion:', error);
        }
    }

    // Add faculty form handler (backend integration)
    document.getElementById('addFacultyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('facultyNameInput');
        const msg = document.getElementById('addFacultyMsg');
        const name = input.value.trim();
        if (!name) return;
        try {
            const response = await fetch('/api/faculty', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const result = await response.json();
            if (result.success) {
                input.value = '';
                msg.textContent = 'Faculty added!';
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 1500);
                updateFacultyDeleteDropdown();
            } else {
                msg.textContent = 'Error: ' + (result.message || 'Could not add faculty');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 2000);
            }
        } catch (err) {
            msg.textContent = 'Server error';
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 2000);
        }
    });

    // Delete faculty form handler (backend integration)
    document.getElementById('deleteFacultyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const select = document.getElementById('facultyDeleteSelect');
        const msg = document.getElementById('deleteFacultyMsg');
        const facultyId = select.value;
        if (!facultyId) return;
        try {
            const response = await fetch(`/api/faculty/${facultyId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) {
                msg.textContent = 'Faculty deleted!';
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 1500);
                updateFacultyDeleteDropdown();
                select.value = '';
            } else {
                msg.textContent = 'Error: ' + (result.message || 'Could not delete faculty');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 2000);
            }
        } catch (err) {
            msg.textContent = 'Server error';
            msg.classList.remove('hidden');
            // Wire up Load Default Subjects button
            const loadDefaultBtn = document.getElementById('loadDefaultBtn');
            if (loadDefaultBtn) {
                loadDefaultBtn.addEventListener('click', loadDefaultSubjects);
            }
            setTimeout(() => msg.classList.add('hidden'), 2000);
        }
    });

    // Helper to update Delete Faculty dropdown (fetch from backend)
    async function updateFacultyDeleteDropdown() {
        const select = document.getElementById('facultyDeleteSelect');
        if (!select) return;
        select.innerHTML = '<option value="">Select faculty to delete</option>';
        try {
            const response = await fetch('/api/faculty');
            const result = await response.json();
            if (result.success && Array.isArray(result.faculty)) {
                result.faculty.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = f.name;
                    select.appendChild(option);
                });
            }
        } catch (err) {
            // Optionally show error
        }
    }

    // On view switch to Add Faculty, update dropdown
    document.getElementById('addFacultyBtn').addEventListener('click', () => {
        updateFacultyDeleteDropdown();
    });

    // Render faculty schedule in the grid and stats
    function renderFacultySchedule(schedule) {
        // Calculate stats
        const totalPeriods = schedule.length;
        let theoryCount = 0, labCount = 0;
        const subjects = new Set();
        schedule.forEach(slot => {
            subjects.add(slot.subject);
            // Simple logic: if subject name contains 'Lab', count as lab
            if (slot.subject.toLowerCase().includes('lab')) labCount++;
            else theoryCount++;
        });
        document.getElementById('facultyTotalPeriods').textContent = totalPeriods;
        document.getElementById('facultyTheoryCount').textContent = theoryCount;
        document.getElementById('facultyLabCount').textContent = labCount;
        document.getElementById('facultySubjectCount').textContent = subjects.size;

        // Render subjects taught
        const subjectsList = document.getElementById('facultySubjectsList');
        subjectsList.innerHTML = '';
        subjects.forEach(subj => {
            const div = document.createElement('div');
            div.className = 'p-2 bg-primary-10 rounded mb-2';
            div.textContent = subj;
            subjectsList.appendChild(div);
        });

        // Render schedule grid
        const grid = document.getElementById('facultyScheduleGrid');
        grid.innerHTML = '';
        // Group by day_of_week
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        let daySlots = {};
        schedule.forEach(slot => {
            if (!daySlots[slot.day_of_week]) daySlots[slot.day_of_week] = [];
            daySlots[slot.day_of_week].push(slot);
        });
        days.forEach((day, idx) => {
            const col = document.createElement('div');
            col.className = 'border p-2';
            col.innerHTML = `<strong>${day}</strong><br>`;
            const slots = daySlots[idx] || [];
            slots.forEach(slot => {
                col.innerHTML += `<div class='mb-1'><span class='font-bold'>${slot.subject}</span> <span class='text-xs'>(${slot.room})</span> <span class='text-xs'>Period ${slot.time_slot+1}</span></div>`;
            });
            grid.appendChild(col);
        });
    }
    </script>
</body>
</html>